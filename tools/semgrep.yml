rules:
  # =============================================
  # A01 - Broken Access Control - OPTIMIZED
  # =============================================
  - id: missing-server-side-auth-check
    message: "Missing server-side authentication/authorization check for sensitive operations"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      function $FUNC($REQ, $RES) {
        ...
        ($DB|db|User|fetch|axios|request).$OPERATION(...);
      }
    metadata:
      category: security
      owasp: "A01:2021 - Broken Access Control"
      cwe: "CWE-862: Missing Authorization"

  - id: client-side-security-check
    message: "Security check implemented only on client side"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      if ($ROLE === "admin" || $PERMISSION) {
        ($DB|db|User|fetch|axios|request).$OPERATION(...);
      }
    metadata:
      category: security
      owasp: "A01:2021 - Broken Access Control"

  # =============================================
  # A02 - Cryptographic Failures
  # =============================================
  - id: weak-hashing-algorithm
    message: "Using weak hashing algorithm (MD5, SHA1)"
    languages: [javascript, typescript]
    severity: ERROR
    pattern-either:
      - pattern: crypto.createHash("md5")
      - pattern: crypto.createHash("sha1")
    metadata:
      category: security
      owasp: "A02:2021 - Cryptographic Failures"
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"

  - id: password-in-plaintext
    message: "Password stored or logged in plaintext"
    languages: [javascript, typescript]
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: console.log(..., $PASSWORD, ...)
          - pattern: console.log($PASSWORD)
          - pattern: console.error(..., $PASSWORD, ...)
          - pattern: logger.log(..., $PASSWORD, ...)
      - metavariable-regex:
          metavariable: $PASSWORD
          regex: (?i).*(password|passwd|pwd|secret|token|apikey|credential).*
      - pattern-not: console.log("...")
      - pattern-not: console.log("...", "...")
    metadata:
      category: security
      owasp: "A02:2021 - Cryptographic Failures"
      cwe: "CWE-312: Cleartext Storage of Sensitive Information"

  # =============================================
  # A03 - Injection
  # =============================================
  - id: sql-injection-concat
    message: "Potential SQL injection via string concatenation"
    languages: [javascript, typescript]
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: $DB.query("..." + $INPUT, ...)
          - pattern: $DB.query($INPUT + "...", ...)
          - pattern: $DB.execute("..." + $INPUT, ...)
          - pattern: $DB.execute($INPUT + "...", ...)
          - pattern: |
              $SQL = "..." + $INPUT;
              ...
              $DB.query($SQL);
      - pattern-not-inside: console.log(...)
      - pattern-not-inside: console.error(...)
      - pattern-not-inside: logger.log(...)
    metadata:
      category: security
      owasp: "A03:2021 - Injection"
      cwe: "CWE-89: SQL Injection"

  - id: nosql-injection
    message: "Potential NoSQL injection with user input"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      $MODEL.find({$KEY: $USER_INPUT})
    metadata:
      category: security
      owasp: "A03:2021 - Injection"
      cwe: "CWE-943: Improper Neutralization of Special Elements in Data Query Logic"

  - id: command-injection
    message: "Potential command injection with user input"
    languages: [javascript, typescript]
    severity: ERROR
    pattern-either:
      - pattern: exec("..." + $USER_INPUT)
      - pattern: execSync("..." + $USER_INPUT)
      - pattern: spawn("sh", ["-c", "..." + $USER_INPUT])
    metadata:
      category: security
      owasp: "A03:2021 - Injection"
      cwe: "CWE-78: Improper Neutralization of Special Elements used in an OS Command"

  # =============================================
  # A05 - Security Misconfiguration
  # =============================================
  - id: debug-mode-production
    message: "Debug mode enabled in production-like environment"
    languages: [javascript, typescript]
    severity: ERROR
    pattern-either:
      - pattern: |
          $APP.set("debug", true);
          ...
          process.env.NODE_ENV = "production";
      - pattern: "debug: true"
    metadata:
      category: security
      owasp: "A05:2021 - Security Misconfiguration"

  - id: insecure-cors
    message: "Insecure CORS configuration with wildcard and credentials"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      app.use(cors({
        origin: "*",
        credentials: true
      }))
    metadata:
      category: security
      owasp: "A05:2021 - Security Misconfiguration"
      cwe: "CWE-942: Permissive Cross-domain Policy with Untrusted Domains"

  # =============================================
  # A06 - Vulnerable and Outdated Components
  # =============================================
  - id: known-vulnerable-package
    message: "Using package with known security vulnerabilities"
    languages: [javascript]
    severity: WARNING
    pattern: |
      "dependencies": {
        ...,
        "express": "4.16.0",
        ...
      }
    metadata:
      category: security
      owasp: "A06:2021 - Vulnerable and Outdated Components"
      cwe: "CWE-1104: Use of Unmaintained Third-Party Components"

  # =============================================
  # A07 - Identification and Authentication Failures
  # =============================================
  - id: insecure-session-cookie
    message: "Session cookie missing secure flags"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      res.cookie("session", $TOKEN, $OPTIONS)
    metadata:
      category: security
      owasp: "A07:2021 - Identification and Authentication Failures"
      cwe: "CWE-614: Sensitive Cookie in HTTPS Session Without 'Secure' Attribute"

  - id: weak-password-validation
    message: "Weak password policy validation"
    languages: [javascript, typescript]
    severity: WARNING
    pattern: |
      if ($PASSWORD.length < 6) {
        return $ERROR;
      }
    metadata:
      category: security
      owasp: "A07:2021 - Identification and Authentication Failures"
      cwe: "CWE-521: Weak Password Requirements"

  - id: jwt-alg-none
    message: "JWT with 'none' algorithm vulnerability"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: 'jwt.verify($TOKEN, $SECRET, {algorithms: ["none"]})'
    metadata:
      category: security
      owasp: "A07:2021 - Identification and Authentication Failures"
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"

  # =============================================
  # A08 - Software and Data Integrity Failures
  # =============================================
  - id: unsafe-deserialization
    message: "Potential unsafe deserialization"
    languages: [javascript, typescript]
    severity: ERROR
    pattern-either:
      - pattern: JSON.parse($UNTRUSTED_INPUT)
      - pattern: eval($UNTRUSTED_INPUT)
    metadata:
      category: security
      owasp: "A08:2021 - Software and Data Integrity Failures"
      cwe: "CWE-502: Deserialization of Untrusted Data"

  # =============================================
  # A10 - Server-Side Request Forgery (SSRF)
  # =============================================
  - id: ssrf-user-input-url
    message: "Potential SSRF with user-controlled URL"
    languages: [javascript, typescript]
    severity: ERROR
    pattern-either:
      - pattern: fetch($USER_INPUT)
      - pattern: axios.get($USER_INPUT)
      - pattern: request($USER_INPUT)
    metadata:
      category: security
      owasp: "A10:2021 - Server-Side Request Forgery"
      cwe: "CWE-918: Server-Side Request Forgery (SSRF)"

  # =============================================
  # General Security Rules
  # =============================================
  - id: hardcoded-secret
    message: "Hardcoded secret or password"
    languages: [javascript, typescript]
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: const $VAR = "sk_..."
          - pattern: let $VAR = "ak_..."
          - pattern: var $VAR = "tk_..."
          - pattern: $VAR = "secret_..."
      - pattern-not-regex: "SEND_USER_DATA_.*"
      - pattern-not: const black = ...
      - pattern-not: export const $VAR = ...
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: hardcoded-credentials
    message: "Hardcoded username or password detected"
    languages: [javascript, typescript]
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              var $VAR = $VALUE
          - pattern: |
              let $VAR = $VALUE
          - pattern: |
              const $VAR = $VALUE
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|passwd|pwd|secret|token|apikey|api_key|access_key|private_key|auth).*
      - metavariable-regex:
          metavariable: $VALUE
          regex: ^"[^"]{1,100}"$
      - pattern-not: var $VAR = ""
      - pattern-not: let $VAR = ""
      - pattern-not: const $VAR = ""
      - pattern-not: var $VAR = "http..."
      - pattern-not: var $VAR = "https..."
      - pattern-not: export const $VAR = ...
      - pattern-not-regex: ".*_(FAILED|SUCCESS|PENDING|ERROR|LOADING|COMPLETE)$"
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A02:2021 - Cryptographic Failures"

  - id: unsafe-redirect
    message: "Unvalidated redirect with user input"
    languages: [javascript, typescript]
    severity: ERROR
    pattern: |
      res.redirect($USER_INPUT)
    metadata:
      category: security
      cwe: "CWE-601: URL Redirection to Untrusted Site ('Open Redirect')"
